name: Bump Reticulum Pin

on:
  schedule:
    - cron: "17 4 * * 1"
  workflow_dispatch:
    inputs:
      reticulum_ref:
        description: "Reticulum-rs branch or tag to track"
        required: false
        default: "master"

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-reticulum-pin:
    name: Bump Reticulum-rs Pin
    runs-on: ubuntu-latest
    steps:
      - name: Checkout LXMF-rs
        uses: actions/checkout@v4

      - name: Resolve target Reticulum-rs revision
        id: resolve
        env:
          INPUT_REF: ${{ github.event.inputs.reticulum_ref }}
        run: |
          set -euo pipefail
          REF="${INPUT_REF:-master}"
          if [[ -z "${REF}" ]]; then
            REF="master"
          fi

          sha=""
          if [[ "${REF}" == refs/* ]]; then
            sha="$(git ls-remote https://github.com/FreeTAKTeam/Reticulum-rs.git "${REF}" | awk '{print $1}' | head -n1)"
          else
            sha="$(git ls-remote https://github.com/FreeTAKTeam/Reticulum-rs.git "refs/heads/${REF}" | awk '{print $1}' | head -n1)"
            if [[ -z "${sha}" ]]; then
              sha="$(git ls-remote https://github.com/FreeTAKTeam/Reticulum-rs.git "refs/tags/${REF}" | awk '{print $1}' | head -n1)"
            fi
          fi

          if [[ -z "${sha}" ]]; then
            echo "Unable to resolve Reticulum-rs ref '${REF}'"
            exit 1
          fi

          echo "ref=${REF}" >> "$GITHUB_OUTPUT"
          echo "sha=${sha}" >> "$GITHUB_OUTPUT"
          echo "Resolved ${REF} -> ${sha}"

      - name: Update pinned revisions
        id: bump
        env:
          NEW_SHA: ${{ steps.resolve.outputs.sha }}
        run: |
          set -euo pipefail

          cargo_sha="$(sed -nE 's/.*reticulum-rs.git", rev = "([0-9a-f]{40})".*/\1/p' Cargo.toml | head -n1)"
          ci_sha="$(sed -nE 's/^[[:space:]]*RETICULUM_RS_REV: ([0-9a-f]{40})/\1/p' .github/workflows/ci.yml | head -n1)"

          if [[ -z "${cargo_sha}" || -z "${ci_sha}" ]]; then
            echo "Failed to parse existing Reticulum-rs pins"
            exit 1
          fi

          echo "old_cargo_sha=${cargo_sha}" >> "$GITHUB_OUTPUT"
          echo "old_ci_sha=${ci_sha}" >> "$GITHUB_OUTPUT"

          if [[ "${cargo_sha}" == "${NEW_SHA}" && "${ci_sha}" == "${NEW_SHA}" ]]; then
            echo "Pins already up to date (${NEW_SHA})"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          perl -0pi -e 's#(reticulum-rs\.git", rev = ")[0-9a-f]{40}(")#$1$ENV{NEW_SHA}$2#g' Cargo.toml
          perl -0pi -e 's#(RETICULUM_RS_REV: )[0-9a-f]{40}#$1$ENV{NEW_SHA}#g' .github/workflows/ci.yml

          cargo update -p reticulum-rs

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.bump.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: automation/bump-reticulum-rs-pin
          delete-branch: true
          commit-message: "chore: bump Reticulum-rs pin to ${{ steps.resolve.outputs.sha }}"
          title: "chore: bump Reticulum-rs pin"
          body: |
            Automated Reticulum-rs pin update.

            - Tracked ref: `${{ steps.resolve.outputs.ref }}`
            - New revision: `${{ steps.resolve.outputs.sha }}`
            - Previous Cargo pin: `${{ steps.bump.outputs.old_cargo_sha }}`
            - Previous CI pin: `${{ steps.bump.outputs.old_ci_sha }}`

            Updated files:
            - `Cargo.toml`
            - `.github/workflows/ci.yml`
            - `Cargo.lock`
